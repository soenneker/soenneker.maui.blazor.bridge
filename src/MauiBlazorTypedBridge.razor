@using Microsoft.Maui
@using Microsoft.Maui.ApplicationModel
@using Microsoft.Maui.Controls
@using Microsoft.Maui.Graphics
@using Microsoft.Maui.Layouts
@using Soenneker.Blazor.CallbackRegistry.Abstract
@using Soenneker.Extensions.ValueTask
@using Soenneker.Maui.Blazor.Bridge.Abstract
@using Soenneker.Maui.Blazor.Bridge.Dtos
@using System.Threading

@inject IBlazorCallbackRegistry BlazorCallbackRegistry
@inject IMauiBlazorBridgeInterop MauiBlazorBridgeInterop

@implements IAsyncDisposable

@typeparam TComponent where TComponent : View, new()

<div id="@ElementId" @ref="_elementReference"></div>

@code {
    private ElementReference _elementReference;
    public readonly string ElementId = Guid.NewGuid().ToString("N");

    [EditorRequired]
    [Parameter]
    public TComponent? Component { get; set; }

    private View? _overlayView;
    private AbsoluteLayout? _overlayContainer;
    private ContentPage? _contentPage;
    private IMauiContext? _mauiContext;

    private bool _initialized;
    private CancellationTokenSource? _cts;

    private double _pageHeight;
    private double _lastYProportion = double.NaN;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_initialized || Component is null)
            return;

        _initialized = true;
        _cts = new CancellationTokenSource();

        await MauiBlazorBridgeInterop.Initialize().NoSync();

        await BlazorCallbackRegistry.Register<MauiBlazorTypedBridge<TComponent>, ElementPositionDto>(
            ElementId,
            this,
            static (self, dto) => self.OnElementPositionReported(dto),
            _cts.Token).NoSync();

        await RenderMauiElement(_cts.Token).NoSync();
    }

    private async ValueTask RenderMauiElement(CancellationToken cancellationToken)
    {
        if (Component is null)
            return;

        Window? window = Application.Current?.Windows.FirstOrDefault();
        if (window?.Page is not ContentPage contentPage)
        {
            Console.WriteLine("No ContentPage available.");
            return;
        }

        _contentPage = contentPage;

        _overlayContainer ??= contentPage.FindByName<AbsoluteLayout>("OverlayContainer");
        if (_overlayContainer is null)
        {
            Console.WriteLine("Overlay container not found. Ensure ContentPage XAML defines AbsoluteLayout x:Name=\"OverlayContainer\".");
            return;
        }

        while (!cancellationToken.IsCancellationRequested && contentPage.Handler?.MauiContext is null)
            await Task.Delay(50, cancellationToken);

        _mauiContext = contentPage.Handler?.MauiContext;
        if (_mauiContext is null)
            return;

        HookPageSize(contentPage);

        // Ensure handler + add overlay must run on main thread
        await MainThread.InvokeOnMainThreadAsync(() =>
        {
            if (Component is null || _overlayContainer is null || _mauiContext is null)
                return;

            EnsureHandler(Component, _mauiContext);

            Layout wrapped = WrapInLayout(Component);
            wrapped.Opacity = 0;

            _overlayView = wrapped;

            AbsoluteLayout.SetLayoutFlags(wrapped, AbsoluteLayoutFlags.PositionProportional);
            AbsoluteLayout.SetLayoutBounds(wrapped, new Rect(0.5, 0.8, AbsoluteLayout.AutoSize, AbsoluteLayout.AutoSize));

            _overlayContainer.Children.Add(wrapped);
        });

        // Brief delay for layout pass, then fade in (FadeTo must be on main thread)
        await Task.Delay(50, cancellationToken);

        View? overlay = _overlayView;
        if (overlay is not null)
            await MainThread.InvokeOnMainThreadAsync(() => overlay.FadeTo(1, 250));

        await MauiBlazorBridgeInterop.ObserveElementPosition(_elementReference, ElementId, cancellationToken).NoSync();
    }

    private void HookPageSize(ContentPage page)
    {
        if (page.Height > 0)
            _pageHeight = page.Height;

        page.SizeChanged -= OnPageSizeChanged;
        page.SizeChanged += OnPageSizeChanged;
    }

    private void OnPageSizeChanged(object? sender, EventArgs e)
    {
        if (sender is Page p && p.Height > 0)
            _pageHeight = p.Height;
    }

    private Task OnElementPositionReported(ElementPositionDto e)
    {
        double height = _pageHeight;

        if (height <= 0 || e.ViewportHeight <= 0)
            return Task.CompletedTask;

        // Compute conversion factor (Maui page height / viewport height).
        double conversionFactor = height / e.ViewportHeight;
        double overlayYCss = e.Top + e.Height + (e.Height * 0.5);
        double overlayYMaui = overlayYCss * conversionFactor;
        double yProportion = overlayYMaui / height;

        if (NearlyEqual(_lastYProportion, yProportion, 0.0005))
            return Task.CompletedTask;

        _lastYProportion = yProportion;

        return MainThread.InvokeOnMainThreadAsync(() =>
        {
            if (_overlayView is null)
                return;

            AbsoluteLayout.SetLayoutFlags(_overlayView, AbsoluteLayoutFlags.PositionProportional);
            AbsoluteLayout.SetLayoutBounds(_overlayView, new Rect(0.5, yProportion, AbsoluteLayout.AutoSize, AbsoluteLayout.AutoSize));
        });
    }

    private static bool NearlyEqual(double a, double b, double epsilon)
    {
        if (double.IsNaN(a) || double.IsNaN(b))
            return false;

        return Math.Abs(a - b) <= epsilon;
    }

    private static void EnsureHandler(View view, IMauiContext mauiContext)
    {
        if (view.Handler is not null)
            return;

        IElementHandler? handler = mauiContext.Handlers.GetHandler(view.GetType());
        if (handler is IViewHandler viewHandler)
        {
            viewHandler.SetMauiContext(mauiContext);
            viewHandler.SetVirtualView(view);
            view.Handler = viewHandler;
        }
    }

    private static Layout WrapInLayout(View mauiComponent)
    {
        // Slightly cheaper than collection initializer (avoids temporary enumerator paths)
        var grid = new Grid
        {
            HorizontalOptions = LayoutOptions.Start,
            VerticalOptions = LayoutOptions.Start,
            BackgroundColor = Colors.Transparent
        };

        grid.RowDefinitions.Add(new RowDefinition { Height = GridLength.Auto });
        grid.ColumnDefinitions.Add(new ColumnDefinition { Width = GridLength.Auto });
        grid.Children.Add(mauiComponent);

        return grid;
    }

    public async ValueTask RemoveElement(bool fade = false)
    {
        BlazorCallbackRegistry.Unregister(ElementId);

        try { await _cts?.CancelAsync(); } catch { }

        Page? page = _contentPage;
        if (page is not null)
            page.SizeChanged -= OnPageSizeChanged;

        await MainThread.InvokeOnMainThreadAsync(async () =>
        {
            if (_overlayView is null)
                return;

            if (fade)
                await _overlayView.FadeTo(0, 250);

            if (_overlayView.Parent is Layout parentLayout)
                parentLayout.Children.Remove(_overlayView);

            _overlayView.Handler?.DisconnectHandler();
            _overlayView.Handler = null;
            _overlayView = null;
        });

        // Be careful: Component is a [Parameter]. Nulling it is surprising to callers.
        // Prefer leaving it alone; just disconnect handlers.
        if (Component is not null)
        {
            Component.DisconnectHandlers();
            Component.Handler = null;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_overlayView is not null)
            await RemoveElement();
    }
}
