@using System.Threading
@using Microsoft.Maui
@using Microsoft.Maui.ApplicationModel
@using Microsoft.Maui.Controls
@using Microsoft.Maui.Graphics
@using Microsoft.Maui.Layouts
@using Soenneker.Blazor.CallbackRegistry.Abstract
@using Soenneker.Extensions.Double
@using Soenneker.Maui.Blazor.Bridge.Abstract
@using Soenneker.Maui.Blazor.Bridge.Dtos
@using Soenneker.Maui.Blazor.Bridge.Utils

@inject IBlazorCallbackRegistry BlazorCallbackRegistry
@inject IMauiBlazorBridgeInterop MauiBlazorBridgeInterop
@implements IAsyncDisposable

<div id="@ElementId" @ref="_elementReference" ></div>

@code {
    private ElementReference _elementReference;

    public readonly string ElementId = Guid.NewGuid()
                                           .ToString("N");

    [EditorRequired]
    [Parameter]
    public Type ComponentType { get; set; } = null!;

    [Parameter]
    public string? Text { get; set; }

    [Parameter]
    public string? TextColor { get; set; }

    [Parameter]
    public string? BackgroundColor { get; set; }

    [Parameter]
    public int? FontSize { get; set; }

    [Parameter]
    public int? Padding { get; set; }

    [Parameter]
    public int? Margin { get; set; }

    [Parameter]
    public int? Width { get; set; }

    [Parameter]
    public int? Height { get; set; }

    [Parameter]
    public double? Opacity { get; set; }

    [Parameter]
    public double? Rotation { get; set; }

    [Parameter]
    public double? Scale { get; set; }

    [Parameter]
    public LayoutOptions? HorizontalOptions { get; set; }

    [Parameter]
    public LayoutOptions? VerticalOptions { get; set; }

    [Parameter]
    public double? X { get; set; }

    [Parameter]
    public double? Y { get; set; }

    [Parameter]
    public bool UseVerticalStack { get; set; }

    [Parameter]
    public bool UseHorizontalStack { get; set; }

    // Don't allocate a Dictionary by default; let callers pass one if needed.
    [Parameter]
    public IReadOnlyDictionary<string, object?>? Properties { get; set; }

    private View? _overlayView;
    private bool _initialized;

    private AbsoluteLayout? _overlayContainer;
    private ContentPage? _contentPage;
    private IMauiContext? _mauiContext;

    private CancellationTokenSource? _cts;

    private double _pageHeight;
    private double _lastYProportion = double.NaN;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_initialized)
            return;

        _initialized = true;
        _cts = new CancellationTokenSource();

        await MauiBlazorBridgeInterop.Initialize();

        // Method group avoids extra async-lambda allocation
        await BlazorCallbackRegistry.Register<ElementPositionDto>(ElementId, OnElementPositionReported);

        await RenderMauiElement(_cts.Token);
    }

    private async ValueTask RenderMauiElement(CancellationToken cancellationToken)
    {
        Window? window = Application.Current?.Windows.FirstOrDefault();
        if (window?.Page is not ContentPage contentPage)
        {
            Console.WriteLine("No ContentPage available.");
            return;
        }

        _contentPage = contentPage;

        _overlayContainer ??= contentPage.FindByName<AbsoluteLayout>("OverlayContainer");
        if (_overlayContainer is null)
        {
            Console.WriteLine("Overlay container not found. Ensure ContentPage XAML defines AbsoluteLayout x:Name=\"OverlayContainer\".");
            return;
        }

        while (!cancellationToken.IsCancellationRequested && contentPage.Handler?.MauiContext is null)
            await Task.Delay(50, cancellationToken);

        _mauiContext = contentPage.Handler?.MauiContext;
        if (_mauiContext is null)
            return;

        HookPageSize(contentPage);

        View? mauiComponent = await MainThread.InvokeOnMainThreadAsync(CreateMauiComponent);
        if (mauiComponent is null)
        {
            Console.WriteLine($"Failed to create component: {ComponentType}");
            return;
        }

        ApplyCommonPropertiesFast(mauiComponent);
        ApplyExtraPropertiesCached(mauiComponent);

        MauiHandlerUtil.ForceHandlerIfNeeded(mauiComponent, _mauiContext);

        Layout wrappedComponent = WrapInLayout(mauiComponent);
        wrappedComponent.Opacity = 0;
        _overlayView = wrappedComponent;

        AbsoluteLayout.SetLayoutFlags(wrappedComponent, AbsoluteLayoutFlags.PositionProportional);

        double xProportion = X ?? 0.5;
        double yProportion = Y ?? 0.8;

        AbsoluteLayout.SetLayoutBounds(wrappedComponent, new Rect(xProportion, yProportion, AbsoluteLayout.AutoSize, AbsoluteLayout.AutoSize));

        await MainThread.InvokeOnMainThreadAsync(() =>
        {
            _overlayContainer!.Children.Add(wrappedComponent);
        });

        await Task.Delay(50, cancellationToken);
        await wrappedComponent.FadeTo(1, 250);

        await MauiBlazorBridgeInterop.ObserveElementPosition(_elementReference, ElementId, cancellationToken);
    }

    private void HookPageSize(ContentPage page)
    {
        if (page.Height > 0)
            _pageHeight = page.Height;

        page.SizeChanged -= OnPageSizeChanged;
        page.SizeChanged += OnPageSizeChanged;
    }

    private void OnPageSizeChanged(object? sender, EventArgs e)
    {
        if (sender is Page p && p.Height > 0)
            _pageHeight = p.Height;
    }

    private Task OnElementPositionReported(ElementPositionDto e)
    {
        // If you need async, keep it async Task.
        return OnElementPositionReportedCore(e);

        async Task OnElementPositionReportedCore(ElementPositionDto dto)
        {
            double height = _pageHeight;
            if (height <= 0 || dto.ViewportHeight <= 0)
                return;

            double conversionFactor = height / dto.ViewportHeight;

            double overlayYCss = dto.Top + dto.Height + (dto.Height * 0.5);
            double overlayYMaui = overlayYCss * conversionFactor;
            double yProportion = overlayYMaui / height;

            if (_lastYProportion.NearlyEqual(yProportion, 0.0005))
                return;

            _lastYProportion = yProportion;

            await MainThread.InvokeOnMainThreadAsync(() =>
            {
                if (_overlayView is null)
                    return;

                AbsoluteLayout.SetLayoutFlags(_overlayView, AbsoluteLayoutFlags.PositionProportional);
                AbsoluteLayout.SetLayoutBounds(_overlayView, new Rect(0.5, yProportion, AbsoluteLayout.AutoSize, AbsoluteLayout.AutoSize));
            });
        }
    }

    private View? CreateMauiComponent()
    {
        if (!typeof(View).IsAssignableFrom(ComponentType))
        {
            Console.WriteLine($"Unsupported or non-view MAUI component: {ComponentType}");
            return null;
        }

        try
        {
            return (View)Activator.CreateInstance(ComponentType)!;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating instance of {ComponentType}: {ex.Message}");
            return null;
        }
    }

    private void ApplyCommonPropertiesFast(View v)
    {
        if (!string.IsNullOrEmpty(BackgroundColor))
            v.BackgroundColor = Color.FromArgb(BackgroundColor);

        if (Width.HasValue)
            v.WidthRequest = Width.Value;
        if (Height.HasValue)
            v.HeightRequest = Height.Value;
        if (Margin.HasValue)
            v.Margin = new Thickness(Margin.Value);
        if (Opacity.HasValue)
            v.Opacity = Opacity.Value;
        if (Rotation.HasValue)
            v.Rotation = Rotation.Value;
        if (Scale.HasValue)
            v.Scale = Scale.Value;

        if (HorizontalOptions.HasValue)
            v.HorizontalOptions = HorizontalOptions.Value;
        if (VerticalOptions.HasValue)
            v.VerticalOptions = VerticalOptions.Value;

        if (X.HasValue)
            v.TranslationX = X.Value;
        if (Y.HasValue)
            v.TranslationY = Y.Value;

        // Fast path for common controls; fallback uses cached setters
        if (!string.IsNullOrEmpty(Text) || !string.IsNullOrEmpty(TextColor) || FontSize.HasValue || Padding.HasValue)
        {
            switch (v)
            {
                case Label label:
                    if (!string.IsNullOrEmpty(Text))
                        label.Text = Text;
                    if (!string.IsNullOrEmpty(TextColor))
                        label.TextColor = Color.FromArgb(TextColor);
                    if (FontSize.HasValue)
                        label.FontSize = FontSize.Value;
                    if (Padding.HasValue)
                        label.Padding = new Thickness(Padding.Value);
                    break;

                case Button button:
                    if (!string.IsNullOrEmpty(Text))
                        button.Text = Text;
                    if (!string.IsNullOrEmpty(TextColor))
                        button.TextColor = Color.FromArgb(TextColor);
                    if (FontSize.HasValue)
                        button.FontSize = FontSize.Value;
                    if (Padding.HasValue)
                        button.Padding = new Thickness(Padding.Value);
                    break;

                case Entry entry:
                    if (!string.IsNullOrEmpty(Text))
                        entry.Text = Text;
                    if (!string.IsNullOrEmpty(TextColor))
                        entry.TextColor = Color.FromArgb(TextColor);
                    if (FontSize.HasValue)
                        entry.FontSize = FontSize.Value;
                    break;

                default:
                    if (!string.IsNullOrEmpty(Text))
                        CachedPropertySetter.TrySet(v, "Text", Text);

                    if (!string.IsNullOrEmpty(TextColor))
                        CachedPropertySetter.TrySet(v, "TextColor", TextColor); // string -> Color handled

                    if (FontSize.HasValue)
                        CachedPropertySetter.TrySet(v, "FontSize", FontSize.Value);

                    if (Padding.HasValue)
                        CachedPropertySetter.TrySet(v, "Padding", Padding.Value);
                    break;
            }
        }
    }

    private void ApplyExtraPropertiesCached(View v)
    {
        IReadOnlyDictionary<string, object?>? props = Properties;
        if (props is null || props.Count == 0)
            return;

        foreach (KeyValuePair<string, object?> kvp in props)
        {
            if (kvp.Value is null)
                continue;

            CachedPropertySetter.TrySet(v, kvp.Key, kvp.Value);
        }
    }

    private Layout WrapInLayout(View mauiComponent)
    {
        if (UseVerticalStack)
        {
            var stack = new VerticalStackLayout
            {
                VerticalOptions = VerticalOptions ?? LayoutOptions.Start,
                HorizontalOptions = HorizontalOptions ?? LayoutOptions.Start,
                BackgroundColor = Colors.Transparent
            };
            stack.Children.Add(mauiComponent);
            return stack;
        }

        if (UseHorizontalStack)
        {
            var stack = new HorizontalStackLayout
            {
                VerticalOptions = VerticalOptions ?? LayoutOptions.Start,
                HorizontalOptions = HorizontalOptions ?? LayoutOptions.Start,
                BackgroundColor = Colors.Transparent
            };
            stack.Children.Add(mauiComponent);
            return stack;
        }

        var grid = new Grid
        {
            HorizontalOptions = LayoutOptions.Start,
            VerticalOptions = LayoutOptions.Start,
            BackgroundColor = Colors.Transparent
        };

        grid.RowDefinitions.Add(new RowDefinition { Height = GridLength.Auto });
        grid.ColumnDefinitions.Add(new ColumnDefinition { Width = GridLength.Auto });
        grid.Children.Add(mauiComponent);

        return grid;
    }

    public async ValueTask RemoveElement(bool fade = false)
    {
        BlazorCallbackRegistry.Unregister(ElementId);

        await MainThread.InvokeOnMainThreadAsync(async () =>
        {
            if (_overlayView is null)
                return;

            if (fade)
                await _overlayView.FadeTo(0, 250);

            if (_overlayView.Parent is Layout parent)
                parent.Children.Remove(_overlayView);

            _overlayView.Handler?.DisconnectHandler();
            _overlayView.Handler = null;
            _overlayView = null;
        });
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await _cts?.CancelAsync();
        }
        catch
        {
        }

        if (_contentPage is not null)
            _contentPage.SizeChanged -= OnPageSizeChanged;

        if (_overlayView is not null)
            await RemoveElement();
    }

}